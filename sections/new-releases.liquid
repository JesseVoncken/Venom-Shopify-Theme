{% comment %}
  Section: New Releases Grid with Full Customization
  Description: Dynamic grid sizing (fills space based on item count) and custom background color.
{% endcomment %}

{%- liquid
  # 1. Calculate Grid Columns based on Product Limit
  # If limit is 2, use 2 cols. If 3, use 3 cols. Cap at 4 cols max for layout sanity.
  assign limit = section.settings.product_limit
  if limit > 4
    assign grid_cols = 4
  else
    assign grid_cols = limit
  endif
-%}

{%- style -%}
  /* Define Dynamic Variables for this section */
  #shopify-section-{{ section.id }} {
    --section-bg-color: {{ section.settings.section_bg_color }};
    --grid-desktop-cols: {{ grid_cols }};
  }

  /* Dynamic Styles for the Background Logo */
  {% if section.settings.background_logo != blank %}
    #shopify-section-{{ section.id }} .new-releases-section::before {
      /* Size Control */
      width: {{ section.settings.logo_size }}%;

      /* Opacity Control */
      opacity: {{ section.settings.logo_opacity | divided_by: 100.0 }};

      {% if section.settings.enable_custom_color %}
        /* RECOLOR MODE */
        background-color: {{ section.settings.logo_color }};
        -webkit-mask-image: url({{ section.settings.background_logo | image_url: width: 1200 }});
        mask-image: url({{ section.settings.background_logo | image_url: width: 1200 }});
        -webkit-mask-repeat: no-repeat;
        -webkit-mask-position: center;
        -webkit-mask-size: contain;
        mask-repeat: no-repeat;
        mask-position: center;
        mask-size: contain;
      {% else %}
        /* ORIGINAL IMAGE MODE */
        background-image: url({{ section.settings.background_logo | image_url: width: 1200 }});
        background-repeat: no-repeat;
        background-position: center;
        background-size: contain;
      {% endif %}
    }
  {% endif %}
{%- endstyle -%}

<div class="new-releases-section">
  <div class="page-width">
    <div class="new-releases-header">
      <div class="header-text">
        {%- if section.settings.subheading != blank -%}
          <h3 class="subheading">{{ section.settings.subheading | escape }}</h3>
        {%- endif -%}
        {%- if section.settings.heading != blank -%}
          <h2 class="heading">{{ section.settings.heading | escape }}</h2>
        {%- endif -%}
      </div>
      {%- if section.settings.button_label != blank and section.settings.button_link != blank -%}
        <a href="{{ section.settings.button_link }}" class="view-all-button">
          {{ section.settings.button_label | escape }}
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="feather feather-chevron-right"
          >
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </a>
      {%- endif -%}
    </div>

    <div class="new-releases-grid">
      {%- assign collection = collections[section.settings.collection] -%}
      {%- for product in collection.products limit: section.settings.product_limit -%}
        <div class="product-card">
          <div class="product-card__image-wrapper">
            {%- if product.tags contains 'new' or section.settings.show_new_badge_always -%}
              <span class="new-badge">NEW</span>
            {%- endif -%}
            <a href="{{ product.url }}" class="product-card__link">
              {%- if product.featured_image != blank -%}
                <img
                  src="{{ product.featured_image | image_url: width: 600 }}"
                  alt="{{ product.title | escape }}"
                  class="product-card__image"
                  loading="lazy"
                  width="600"
                  height="{{ 600 | divided_by: product.featured_image.aspect_ratio | ceil }}"
                >
              {%- else -%}
                {{ 'product-1' | placeholder_svg_tag: 'product-card__image placeholder' }}
              {%- endif -%}
            </a>
          </div>
          <div class="product-card__info">
            {%- if section.settings.show_vendor -%}
              <span class="product-vendor">{{ product.vendor }}</span>
            {%- endif -%}
            <h3 class="product-title">
              <a href="{{ product.url }}">{{ product.title }}</a>
            </h3>
            <div class="product-price-stock">
              <span class="product-price">{{ product.price | money }}</span>
              {%- if product.available and section.settings.show_stock -%}
                {%- assign stock_count = product.variants.first.inventory_quantity -%}
                {%- if stock_count > 0 -%}
                  <span class="product-stock">{{ stock_count }} IN STOCK</span>
                {%- endif -%}
              {%- endif -%}
            </div>
          </div>
        </div>
      {%- else -%}
        {%- for i in (1..section.settings.product_limit) -%}
          <div class="product-card">
            <div class="product-card__image-wrapper">
              <span class="new-badge">NEW</span>
              {{ 'product-' | append: i | placeholder_svg_tag: 'product-card__image placeholder' }}
            </div>
            <div class="product-card__info">
              <span class="product-vendor">VENDOR</span>
              <h3 class="product-title">Example Product Title</h3>
              <div class="product-price-stock">
                <span class="product-price">$30.00</span>
                <span class="product-stock">7 IN STOCK</span>
              </div>
            </div>
          </div>
        {%- endfor -%}
      {%- endfor -%}
    </div>
  </div>
</div>

<style>
  .new-releases-section {
    background-color: var(--section-bg-color); /* Uses the picker selection */
    padding: 60px 0;
    color: white;
    position: relative;
    overflow: hidden;
  }

  /* BASE STYLES FOR BACKGROUND LOGO */
  .new-releases-section::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    aspect-ratio: 1 / 1;
    height: auto;
    padding-bottom: 100%;
    z-index: 1;
    pointer-events: none;
  }

  .new-releases-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-bottom: 40px;
    position: relative;
    z-index: 2;
  }

  .subheading {
    display: block;
    font-size: 14px;
    color: #007bff;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 10px;
    font-weight: bold;
    font-family: var(--font-body-family);
    font-style: var(--font-body-style);
  }
  .heading {
    font-size: 48px;
    font-weight: 900;
    text-transform: uppercase;
    margin: 0;
    line-height: 1;
  }

  .view-all-button {
    display: inline-flex;
    align-items: center;
    padding: 12px 24px;
    background-color: white;
    color: black;
    font-size: 14px;
    font-weight: bold;
    text-transform: uppercase;
    text-decoration: none;
    border-radius: 4px;
    transition: background-color 0.3s ease;
    white-space: nowrap;
  }
  .view-all-button:hover {
    background-color: #e6e6e6;
  }
  .view-all-button svg {
    margin-left: 8px;
  }

  .new-releases-grid {
    display: grid;
    /* DYNAMIC GRID: Uses the calculated column count */
    grid-template-columns: repeat(var(--grid-desktop-cols), 1fr);
    gap: 25px;
    position: relative;
    z-index: 2;
  }

  .product-card {
    overflow: hidden;
    transition: transform 0.3s ease;
  }
  .product-card:hover {
    transform: translateY(-5px);
  }
  .product-card__image-wrapper {
    position: relative;
    aspect-ratio: 4 / 5;
    background-color: #2a2a2a;
    overflow: hidden;
    border-radius: 8px;
  }

  .new-badge {
    position: absolute;
    top: 15px;
    left: 15px;
    background-color: #007bff;
    color: white;
    font-size: 12px;
    font-weight: bold;
    padding: 5px 10px;
    border-radius: 4px;
    z-index: 2;
  }

  .product-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }
  .product-card:hover .product-card__image {
    transform: scale(1.05);
  }
  .product-card__image.placeholder {
    padding: 40px;
    fill: #444;
  }

  .product-card__info {
    padding: 20px;
  }
  .product-vendor {
    display: block;
    font-size: 12px;
    color: #007bff;
    text-transform: uppercase;
    margin-bottom: 5px;
    font-weight: bold;
  }
  .product-title {
    margin: 0 0 10px;
    font-size: 16px;
    font-weight: normal;
    line-height: 1.4;
    font-family: var(--font-body-family);
  }
  .product-title a {
    color: white;
    text-decoration: none;
  }
  .product-price-stock {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .product-price {
    font-size: 20px;
    font-weight: 900;
  }
  .product-stock {
    font-size: 12px;
    color: #007bff;
    font-weight: bold;
    text-transform: uppercase;
  }

  @media (max-width: 1024px) {
    .new-releases-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  @media (max-width: 768px) {
    .new-releases-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 20px;
    }
    .heading {
      font-size: 36px;
    }
    .new-releases-grid {
      /* Force single column on mobile */
      grid-template-columns: 1fr;
    }
    .product-card__image-wrapper {
      aspect-ratio: 1 / 1;
    }
  }
</style>

{% schema %}
{
  "name": "New Releases Grid",
  "settings": [
    { "type": "header", "content": "Section Styles" },
    {
      "type": "color",
      "id": "section_bg_color",
      "label": "Section Background Color",
      "default": "#212121"
    },
    { "type": "header", "content": "Content" },
    { "type": "text", "id": "subheading", "label": "Subheading", "default": "The Latest Drops" },
    { "type": "text", "id": "heading", "label": "Heading", "default": "NEW RELEASES." },
    { "type": "text", "id": "button_label", "label": "Button Label", "default": "VIEW ALL DROPS" },
    { "type": "url", "id": "button_link", "label": "Button Link" },
    { "type": "collection", "id": "collection", "label": "Collection" },
    { "type": "range", "id": "product_limit", "min": 2, "max": 8, "step": 1, "default": 4, "label": "Product Limit" },

    { "type": "header", "content": "Product Card" },
    { "type": "checkbox", "id": "show_vendor", "label": "Show Vendor", "default": true },
    { "type": "checkbox", "id": "show_stock", "label": "Show Stock", "default": true },
    { "type": "checkbox", "id": "show_new_badge_always", "label": "Always Show 'NEW'", "default": false },

    { "type": "header", "content": "Background Logo Settings" },
    {
      "type": "image_picker",
      "id": "background_logo",
      "label": "Logo Image",
      "info": "Upload a transparent PNG."
    },
    {
      "type": "range",
      "id": "logo_size",
      "min": 10,
      "max": 200,
      "step": 5,
      "label": "Logo Size",
      "default": 80,
      "unit": "%"
    },
    {
      "type": "range",
      "id": "logo_opacity",
      "min": 0,
      "max": 100,
      "step": 5,
      "label": "Logo Opacity",
      "default": 10,
      "unit": "%"
    },
    {
      "type": "checkbox",
      "id": "enable_custom_color",
      "label": "Recolor Logo?",
      "default": false,
      "info": "If checked, logo will be a solid block of the color selected below."
    },
    {
      "type": "color",
      "id": "logo_color",
      "label": "Logo Custom Color",
      "default": "#007bff"
    }
  ],
  "presets": [{ "name": "New Releases Grid" }]
}
{% endschema %}
